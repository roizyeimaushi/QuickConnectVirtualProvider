# ==========================================================
# RENDER BLUEPRINT - LARAVEL BACKEND + POSTGRES
# ==========================================================
services:
  # --------------------------------------------------------
  # LARAVEL BACKEND (Docker)
  # --------------------------------------------------------
  - type: web
    name: quickconnect-api
    runtime: docker
    region: singapore
    plan: free
    
    # Point to the Backend Dockerfile we fixed
    dockerfilePath: backend/quickcon-api/Dockerfile.render
    dockerContext: backend/quickcon-api
    
    healthCheckPath: /api/health

    # Environment Variables
    envVars:
      - key: APP_NAME
        value: QuickConnect
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: "false"
      - key: FORCE_RESET_DB
        sync: false # Set to "true" in Dashboard to wipe DB on next deploy
      # APP_KEY will be auto-generated by start.sh if not in correct format
      # You can also manually set: base64:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx= (32 random bytes, base64 encoded)
      - key: APP_KEY
        sync: false
      - key: APP_URL
        sync: false  # Render will auto-fill this URL after deploy

      # Database Configuration (Auto-linked to service below)
      - key: DB_CONNECTION
        value: pgsql
      - key: DB_HOST
        fromDatabase:
          name: quickconnect-db
          property: host
      - key: DB_PORT
        fromDatabase:
          name: quickconnect-db
          property: port
      - key: DB_DATABASE
        fromDatabase:
          name: quickconnect-db
          property: database
      - key: DB_USERNAME
        fromDatabase:
          name: quickconnect-db
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: quickconnect-db
          property: password

      # Frontend Connection (Update these in Render Dashboard later if domain changes)
      - key: CORS_ALLOWED_ORIGINS
        value: https://quickconnect-frontend.vercel.app,http://localhost:3000
      - key: SANCTUM_STATEFUL_DOMAINS
        value: quickconnect-frontend.vercel.app,localhost:3000
      
      # Logging & Session
      - key: LOG_CHANNEL
        value: stderr
      - key: SESSION_DRIVER
        value: file
      - key: SESSION_SECURE_COOKIE
        value: "true"

# --------------------------------------------------------
# POSTGRESQL DATABASE (Free Tier)
# --------------------------------------------------------
databases:
  - name: quickconnect-db
    region: singapore
    plan: free
    databaseName: quickconnect
    user: quickconnect_user

version: "1"
