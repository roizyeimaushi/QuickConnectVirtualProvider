# Render Blueprint - MONOLITH (Single Service)
# Next.js + Laravel in ONE container
# Simpler deployment, lower cost (1 service instead of 2)

services:
  # ============================================
  # SINGLE SERVICE - Next.js + Laravel Together
  # ============================================
  - type: web
    name: quickconn-app
    runtime: docker
    region: singapore  # Change to your preferred region
    plan: starter  # Recommended for monolith (needs more RAM)
    dockerfilePath: ./Dockerfile.monolith
    dockerContext: .
    healthCheckPath: /api/health
    envVars:
      # ==========================================
      # APPLICATION
      # ==========================================
      - key: APP_NAME
        value: "QuickConn Attendance"
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: "false"
      - key: APP_KEY
        generateValue: true
      - key: APP_URL
        fromService:
          type: web
          name: quickconn-app
          property: host
      
      # ==========================================
      # LOGGING
      # ==========================================
      - key: LOG_CHANNEL
        value: stderr
      - key: LOG_LEVEL
        value: error
      
      # ==========================================
      # DATABASE - TiDB Cloud
      # ==========================================
      - key: DB_CONNECTION
        value: mysql
      - key: DB_HOST
        value: gateway01.ap-southeast-1.prod.aws.tidbcloud.com
      - key: DB_PORT
        value: "4000"
      - key: DB_DATABASE
        value: test
      - key: DB_USERNAME
        value: 2rcbbSwyn9vf1YB.root
      - key: DB_PASSWORD
        sync: false  # Set this manually in Render Dashboard for security
      - key: MYSQL_ATTR_SSL_CA
        value: /etc/ssl/certs/ca-certificates.crt
      
      # ==========================================
      # SESSIONS & CACHE
      # ==========================================
      - key: SESSION_DRIVER
        value: file
      - key: SESSION_LIFETIME
        value: "120"
      - key: CACHE_STORE
        value: file
      - key: QUEUE_CONNECTION
        value: sync
      - key: FILESYSTEM_DISK
        value: local
      
      # ==========================================
      # FRONTEND CONFIG
      # ==========================================
      - key: NEXT_PUBLIC_API_URL
        value: ""  # Empty = same origin (monolith)
      
      # ==========================================
      # CORS (Not needed for monolith - same origin)
      # ==========================================
      - key: SANCTUM_STATEFUL_DOMAINS
        value: "localhost"
      - key: CORS_ALLOWED_ORIGINS
        value: "*"
      - key: ALLOW_EXTERNAL_ACCESS
        value: "true"
      
      # ==========================================
      # SECURITY
      # ==========================================
      - key: BCRYPT_ROUNDS
        value: "12"
      - key: MAIL_MAILER
        value: log

# ============================================
# DEPLOYMENT NOTES
# ============================================
#
# ADVANTAGES OF MONOLITH:
#   ✅ Single service = lower cost
#   ✅ Same-origin = no CORS issues
#   ✅ Simpler configuration
#   ✅ Faster internal API calls
#
# REQUIREMENTS:
#   ⚠️ Use 'starter' plan or higher (512MB+ RAM)
#   ⚠️ Free plan may timeout during build
#
# SETUP STEPS:
#   1. Create MySQL database (PlanetScale recommended)
#   2. Push code to GitHub
#   3. Create Blueprint in Render
#   4. Set DB_HOST, DB_DATABASE, DB_USERNAME, DB_PASSWORD
#   5. Deploy!
#
# URLS AFTER DEPLOY:
#   Frontend: https://quickconn-app.onrender.com/
#   API:      https://quickconn-app.onrender.com/api/
#   Health:   https://quickconn-app.onrender.com/api/health
